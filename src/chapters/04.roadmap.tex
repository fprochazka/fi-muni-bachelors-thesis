\chapter{Roadmap of refactoring}

This chapter contains overview of the plan for refactoring. \ref{sec:roadmap:deprecations} explains what packages will be deprecated and why. \ref{sec:roadmap:common} evaluates common requirements for all the packages that will undergo refactoring. Finally \ref{sec:roadmap:each-package} describes specific plan for the individual packages, if there are any.

\section{Deprecations} \label{sec:roadmap:deprecations}

Deprecating a package means it will be visibly marked on Github as not maintained anymore and on Packagist there is a specific feature for abandoning packages. When somebody tries to install abandoned the package, Composer will show a warning that the package is not maintained and they should migrate away from it. Deprecation is reversible and if somebody who is using the package wants to start taking care of it, I will allow it and assign them the maintainer permissions.

New maintainer for \gls{kCsobPaymentGateway} and \gls{kCsobPaygateNette} was not found and therefore it would be dangerous to encourage use of these packages in such critical piece of infrastructure without having a maintainer that uses them in production. They are both going to be deprecated. They are well tested and work correctly with the versions of ÄŒSOB payment gateway and \gls{nette} they are written for. The users of these packages will have to migrate to \fnurl{slevomat/csob-gateway}{https://github.com/slevomat/csob-gateway}.

\gls{kDoctrineSearch} will be deprecated and no attempts of fixing it will be made by me. It is based on a prototype package and no stable versions were released. If anybody was using it, they were doing so knowingly risking this outcome.

There will be new releases for \gls{nette} 2.3 and 2.4 of \gls{kFacebook}, \gls{kGoogle} and \gls{kGithub}. But after that, the packages will be deprecated. The OAuth 2 is a standard and all the providers adhere to it with only slight variations. Generic library like \fnurl{league/oauth2-client}{https://github.com/thephpleague/oauth2-client} that implements the standard rather than separate integrations with each provider is more sustainable.

All Kdyby packages will drop support for \gls{hhvm}. It has too low adoption to outweigh the extra maintenance work it requires and supporting \gls{hhvm} on packages that depend on \gls{nette} is impossible.

\section{Common requirements} \label{sec:roadmap:common}

Every package is specific, but there is set of standards that have to be enforced for all good \gls{oss} PHP projects and it is constantly evolving. Having only tests and documentation is no longer the only best practice. The following sections cover the current trends.

\hiddensubsection{Static analysis with PHPStan}

\fnurl{PHPStan}{https://github.com/phpstan/phpstan} claims to be a static analysis tool that can discover bugs in source code. It does not find all bugs, but it has a lot of helpful checks. Running such tool on Kdyby packages in \gls{ci} is going to increase confidence in the correctness of the packages and help prevent introducing new bugs.

But there is a problem with PHPStan - it is not really a static analysis tool. It does analyze the code, but not statically. It uses two tools for its analysis - \fnurl{PHP Parser}{https://github.com/nikic/PHP-Parser} and \fnurl{native PHP reflection}{http://php.net/manual/en/book.reflection.php}. First it parses the source code using the PHP Parser and when it finds a class \fnurl{PHPStan loads the file into memory and executes it}{https://github.com/phpstan/phpstan/issues/137} which makes it available for the PHP reflection. This would not be a problem on itself with source code that has no side effects but PHPStan has 3rd party dependencies that might clash with dependencies of the project it is analyzing. One of them is \gls{sfConsole}. If PHPStan was to analyze the source code of \gls{sfConsole} it would not be analyzing the source code of the library it would be executed on, but the source code of its own dependency, because it uses the native PHP reflection.

This problem has several solutions. PHPStan can be rewritten to not use the native PHP reflection, but emulated one that works on top of the PHP Parser. The author does not like this solution because he is worried about speed of the tool. PHPStan can be rewritten to drop all dependencies and re--implement the functionality the libraries provide. This solution is not good because it would create additional and unnecessary overhead for the maintainers. Or we can implement a compiler that preprocesses the source code of PHPStan and its dependencies and fixes the problem.

Citing the PHP documentation, PHAR provides a way to put entire PHP applications into a single file called a PHP Archive for easy distribution and installation~\cite{php:phar}. PHPStan has also opened an issue \fnurl{PHAR file for each release}{https://github.com/phpstan/phpstan/issues/110} where community is requesting releases to be made also in PHAR.

I am going to implement a compiler that fixes the problem with type collisions and creates a PHAR distribution of the tool. I am also going to offer the author to take over the project afterwards so he can make it official part of the PHPStan ecosystem.

\hiddensubsection{Coding Standard with \gls{phpCs}}

Kdyby has a coding standard from the beginning that is based on \gls{nette} coding standard, but no tool is automatically enforcing it. I have refused to use \fnurl{\gls{phpCs}}{https://github.com/squizlabs/PHP_CodeSniffer} in the past because it does not have good architecture and did not support the rules Kdyby Coding Standard required and somebody would have to implement them first. Now there is \fnurl{slevomat/coding-standard}{https://github.com/slevomat/coding-standard} project that covers most of the needs Kdyby has and it is reasonable to revisit \gls{phpCs} now.

Kdyby will use \fnurl{consistence/coding-standard}{https://github.com/consistence/coding-standard} as a base definition. Consistence Coding Standard includes the slevomat/coding-standard rules. Kdyby Coding Standard will inherit it and modify the rules settings to account for the differences in the standards.

\hiddensubsection{\gls{nette} 2.3 and 2.4 compatible versions}

Each supported package that depends on \gls{nette} must be fixed for \gls{nette} 2.3 if that is not unreasonable amount of work. Otherwise the 2.3 will be skipped. Then the minimum required version will be increased to \gls{nette} 2.4 and another fixed version will be released that will preferably drop all code that handled backwards compatibility with old \gls{nette}. This will allow for less source code and will serve as a better base for future releases.

Releasing the versions that solve compatibility with current \gls{nette} versions is a more important than applying the new Coding Standard and will be prioritized.

\hiddensubsection{PHP 5.6 and newer only}

After the bugfix versions are released, all packages will drop compatibility with PHP 5.5 or older in master branch. No new feature releases will support old PHP unless there is a critical bug that will require a patch release for older version of package. Compatibility with PHP 7.0 and 7.1 will be fixed and enforced by \gls{ci}.

All the packages have gathered some bug reports in their issue trackers. What can be fixed for \gls{nette} 2.3 or 2.4 will be fixed before that release. Everything else that requires architecture changes to fix the problems or implement new features will not be implemented before the minimum requirement of PHP 5.6 is enforced. It will also not be implemented before the package is fixed based on the PHPStan analysis and new Coding Standard is applied and enforced.

\hiddensubsection{PHP 7.1 and newer}

Kdyby packages will skip minimum requirement of PHP 7.0. After the support for PHP 5.6 is dropped the support for PHP 7.0 will be dropped with it. PHP 7.0 introduces return value typehinting and scalar typehinting, allowing to declare if argument should be string or integer which was not possible until PHP 7.0. But it is missing \fnurl{nullable types}{http://php.net/manual/en/migration71.new-features.php\#migration71.new-features.nullable-types} and \fnurl{void return type}{http://php.net/manual/en/migration71.new-features.php\#migration71.new-features.void-functions} which are both important and the new type system is incomplete without them.

PHP 7.1 releases will not be part of refactoring covered by this thesis but they are an important part of the roadmap and should be mentioned.

\hiddensubsection{Framework agnostic libraries}

Most of the packages are integration of some tool into \gls{nette} but many of them extend the functionality of the original package making them a candidate for a split into two or more packages. Great example of this is \gls{kDoctrine} that accumulated many extra features. If such package was installed into a \gls{sf} application, it would drag along all its dependencies and tight coupling for \gls{nette}. The extra dependencies can be ignored and it would most likely work, but that is not the best way to develop applications.

The solution to this problem is to extract the functionality from the packages that violate the Unix philosophy to do one thing only and to do it right. The extracted packages that are framework agnostic can be used with \gls{sf} or with other PHP frameworks easily and the \gls{nette} community will benefit from bigger potential user base which inherently makes any \gls{oss} better.

\section{Specific requirements for each package} \label{sec:roadmap:each-package}

This section will only broadly cover the interesting and big architectural changes that will be made and not go in depth in all the issues that have to be fixed.

\hiddensubsection{Console}

The URL generating problem with \gls{nette} was resolved by introduction of \lstinline{LinkGenerator} service. \gls{kConsole} can therefore drop the entire abstraction that was fixing problem.

\hiddensubsection{Events}

After fixing the compatibility with \gls{nette} 2.3 and 2.4 there will be a big change of philosophy in this package. The EventManager that \gls{kDoctrine} requires will be simplified and moved to a bridge package between \gls{nette} and \gls{doctrine}. Its only responsibility will be making sure the event subscriber classes for \gls{doctrine} are lazy--initialized and fetched from \gls{dic} only when they are required. The rest of the package will be deprecated and users will be encouraged to use \gls{sfEventDispatcher} in new projects.

% \hiddensubsection{DoctrineDbalBatchImport}

% This package has no stable release yet because it is only one helper class extracted from \gls{kDoctrine}. It will be refactored to a modern \gls{oo} API.

\hiddensubsection{Doctrine}

TODO.

\hiddensubsection{Translation}

The \lstinline{^3.0} releases of \gls{sfTranslation} solve problems that \gls{kTranslation} tried to fix and a lot of code can be removed completely.

\hiddensubsection{Clock}

\gls{kClock} will be separated into two packages where one would only cover implementing the \lstinline{DateTimeProvider} itself and the other package will integrate it with \gls{nette}.

\hiddensubsection{Geocoder}

Four new packages will be extracted from \gls{kGeocoder} and this package will be deprecated. There will be \gls{kGeocoderLogging}, \gls{kGeocoderSeznamMaps}, \gls{kGeocoderGoogleMapsProxied} and \gls{kGeocoderBestMatch}.

\hiddensubsection{Wkhtmltopdf}

This package implements a custom process handling that should be replaced with \fnurl{symfony/process}{https://github.com/symfony/process}. It also contains both the implementation of the CLI \gls{oo} abstraction and the \gls{nette} integration itself. These responsibilities will be separated into separate packages.
