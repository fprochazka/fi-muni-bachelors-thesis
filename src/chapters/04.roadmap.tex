\chapter{Designing roadmap of refactoring}

This chapter contains overview of the plan for refactoring. \ref{sec:roadmap:deprecations} explains what packages will be deprecated and why. \ref{sec:roadmap:common} evaluates common requirements for all the packages, that will undergo refactoring. Finally \ref{sec:roadmap:each-package} describes specific plan for the individual packages, if there are any.

\section{Deprecations} \label{sec:roadmap:deprecations}

New maintainer for \gls{kCsobPaymentGateway} and \gls{kCsobPaygateNette} was not found and therefore it would be dangerous to encourage use of these packages in such critical piece of infrastructure without having a maintainer that uses them in production. They are both going to be deprecated. They are well tested and work correctly with the versions of ÄŒSOB payment gateway and \gls{nette} they are written for. The users of these packages will have to migrate to \fnurl{slevomat/csob-gateway}{https://github.com/slevomat/csob-gateway}.

All Kdyby packages will drop support for \gls{hhvm}. It has too low adoption to outweigh the extra maintenance work it requires and supporting \gls{hhvm} on packages that depend on \gls{nette} is impossible.

\section{Common requirements} \label{sec:roadmap:common}

Every package is specific, but there is set of standards that have to be enforced for all good \gls{oss} PHP projects and it is constantly evolving. Having only tests and documentation is no longer the only best practice. The following sections cover the requirements.

\hiddensubsection{\gls{nette} 2.3 and 2.4 compatible versions}

Each supported package that depends on \gls{nette} must be fixed for \gls{nette} 2.3 if that is not unreasonable amount of work. Otherwise the 2.3 will be skipped. Then the minimum required version will be increased to \gls{nette} 2.4 and another fixed version will be released that will preferably drop all code that handled backwards compatibility with old \gls{nette}. This will allow for less source code and will serve as a better base for future releases.

\hiddensubsection{PHP 5.6 and newer only}

After the bugfix versions are released, all packages will drop compatibility with PHP 5.5 or older in master branch. No new feature releases will support old PHP unless there is a critical bug that will require a patch release for older version of package. Compatibility with PHP 7.0 and 7.1 will be fixed and enforced by \gls{ci}.

\hiddensubsection{Static analysis with PHPStan}

\fnurl{PHPStan}{https://github.com/phpstan/phpstan} claims to be a static analysis tool that can discover bugs in source code. It does not find all bugs, but it has a lot of helpful checks. Running such tool on Kdyby packages in \gls{ci} is going to increase confidence in the correctness of the packages and help prevent introducing new bugs.

But there is a problem with PHPStan - it is not really a static analysis tool. It does analyze the code, but not statically. It uses two tools for its analysis - \fnurl{PHP Parser}{https://github.com/nikic/PHP-Parser} and \fnurl{native PHP reflection}{http://php.net/manual/en/book.reflection.php}. First it parses the source code using the PHP Parser and when it finds a class \fnurl{PHPStan loads the file into memory and executes it}{https://github.com/phpstan/phpstan/issues/137} which makes it available for the PHP reflection. This would not be a problem on itself with source code that has no side effects but PHPStan has 3rd party dependencies that might clash with dependencies of the project it is analyzing. One of them is \gls{sfConsole}. If PHPStan was to analyze the source code of \gls{sfConsole} it would not be analyzing the source code of the library it would be executed on, but the source code of its own dependency, because it uses the native PHP reflection.

This problem has several solutions. PHPStan can be rewritten to not use the native PHP reflection, but emulated one that works on top of the PHP Parser. The author does not like this solution because he is worried about speed of the tool. PHPStan can be rewritten to drop all dependencies and re--implement the functionality the libraries provide. This solution is not good because it would create additional and unnecessary overhead for the maintainers. Or we can implement a compiler that preprocesses the source code of PHPStan and its dependencies and fixes the problem.

Citing the PHP documentation, PHAR provides a way to put entire PHP applications into a single file called a PHP Archive for easy distribution and installation~\cite{php:phar}. PHPStan has also opened an issue \fnurl{PHAR file for each release}{https://github.com/phpstan/phpstan/issues/110} where community is requesting releases to be made also in PHAR.

I am going to implement a compiler that fixes the problem with type collisions and creates a PHAR distribution of the tool. I am also going to offer the author to take over the project afterwards so he can make it official part of the PHPStan ecosystem.

\hiddensubsection{Coding Standard with \gls{phpCs}}

Kdyby has a coding standard from the beginning that is based on \gls{nette} coding standard, but no tool is automatically enforcing it. I have refused to use \fnurl{\gls{phpCs}}{https://github.com/squizlabs/PHP_CodeSniffer} in the past because it does not have good architecture and did not support the rules Kdyby Coding Standard required and somebody would have to implement them first. Now there is \fnurl{slevomat/coding-standard}{https://github.com/slevomat/coding-standard} project, that covers most of the needs Kdyby has and it is reasonable to revisit \gls{phpCs} now.

Kdyby will use \fnurl{consistence/coding-standard}{https://github.com/consistence/coding-standard} as a base definition. Consistence Coding Standard includes the slevomat/coding-standard rules. Kdyby Coding Standard will inherit it and modify the rules settings to account for the differences in the standards.

\hiddensubsection{PHP 7.1 and newer}

Kdyby packages will skip PHP 7.0 and after the support for PHP 5.6 will be dropped the support for PHP 7.0 will be dropped with it. The PHP 7.0 introduces return value typehinting and scalar typehinting, allowing to declare if argument should be string or integer which was not possible until PHP 7.0. But it is missing \fnurl{nullable types}{http://php.net/manual/en/migration71.new-features.php\#migration71.new-features.nullable-types} and \fnurl{void return type}{http://php.net/manual/en/migration71.new-features.php\#migration71.new-features.void-functions} which are both important and the new type system is incomplete without them.

The PHP 7.1 releases will not be part of refactoring covered by this thesis but they are an important part of the roadmap and should be mentioned.

\section{Specific requirements for each package} \label{sec:roadmap:each-package}

\hiddensubsection{Doctrine}

Lorem ipsum.

\hiddensubsection{Console}

Lorem ipsum.

\hiddensubsection{Events}

Lorem ipsum.

\hiddensubsection{Annotations}

Lorem ipsum.

\hiddensubsection{DoctrineCache}

Lorem ipsum.

\hiddensubsection{DoctrineMagicAccessors}

Lorem ipsum.

\hiddensubsection{DoctrineCollectionsReadonly}

Lorem ipsum.

\hiddensubsection{DoctrineCollectionsLazy}

Lorem ipsum.

\hiddensubsection{DoctrineDbalBatchImport}

Lorem ipsum.

\hiddensubsection{DoctrineForms}

Lorem ipsum.

\hiddensubsection{Autowired}

Lorem ipsum.

\hiddensubsection{FormsReplicator}

Lorem ipsum.

\hiddensubsection{Translation}

Lorem ipsum.

\hiddensubsection{Validator}

Lorem ipsum.

\hiddensubsection{RabbitMq}

Lorem ipsum.

\hiddensubsection{Money}

Lorem ipsum.

\hiddensubsection{DoctrineMoney}

Lorem ipsum.

\hiddensubsection{Aop}

Lorem ipsum.

\hiddensubsection{Clock}

Lorem ipsum.

\hiddensubsection{Redis}

Lorem ipsum.

\hiddensubsection{ParseUseStatements}

Lorem ipsum.

\hiddensubsection{RedisActiveLock}

Lorem ipsum.

\hiddensubsection{TesterParallelStress}

Lorem ipsum.

\hiddensubsection{Monolog}

Lorem ipsum.

\hiddensubsection{ElasticSearch}

Lorem ipsum.

\hiddensubsection{DoctrineSearch}

Lorem ipsum.

\hiddensubsection{Geocoder}

Lorem ipsum.

\hiddensubsection{CsobPaygateNette}

Lorem ipsum.

\hiddensubsection{CsobPaymentGateway}

Lorem ipsum.

\hiddensubsection{Wkhtmltopdf}

Lorem ipsum.

\hiddensubsection{FakeSession}

Lorem ipsum.

\hiddensubsection{RequestStack}

Lorem ipsum.

\hiddensubsection{StrictObjects}

Lorem ipsum.

\hiddensubsection{Facebook}

Lorem ipsum.

\hiddensubsection{Google}

Lorem ipsum.

\hiddensubsection{Github}

Lorem ipsum.

\hiddensubsection{NettePhpServer}

Lorem ipsum.

\hiddensubsection{TesterExtras}

Lorem ipsum.

\hiddensubsection{HtmlValidatorPanel}

Lorem ipsum.
